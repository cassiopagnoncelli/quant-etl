<% content_for :title, "Time Series" %>

<div class="container" data-controller="pipeline-toggle">
  <div class="header-section" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Available Time Series</h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
      <input type="text" 
             id="filter-input" 
             placeholder="Filter series..." 
             style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; width: 200px;"
             oninput="filterTimeSeries(this.value)">
      <%= button_to sync_time_series_index_path, method: :post, class: "sync-clickable" do %>
        <span class="sync-icon-container">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 4v6h-6"></path>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          <span class="sync-count"><%= @outdated_count %></span>
        </span>
      <% end %>
    </div>
  </div>

  <% if @time_series_by_source.empty? %>
    <div class="empty-state">
      <h3>No time series available</h3>
      <p>There are currently no time series in the system.</p>
    </div>
  <% else %>
    <% @time_series_by_source.each do |source, time_series_list| %>
      <div class="source-group" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; margin-bottom: 1rem;">
          <h2 style="color: #333; margin: 0;">
            <%= source %> 
            <span style="font-size: 0.7em; color: #666; font-weight: normal;">(<%= pluralize(time_series_list.count, 'series') %>)</span>
          </h2>
          
          <% pipeline_status = @source_pipeline_status[source] %>
          <% if pipeline_status[:has_pipelines] %>
            <div class="pipeline-toggle-container">
              <label class="toggle-switch" data-source="<%= source %>">
                <input type="checkbox" 
                       class="pipeline-toggle" 
                       data-source="<%= source %>"
                       <%= 'checked' if pipeline_status[:all_active] %>>
                <span class="toggle-slider"></span>
              </label>
            </div>
          <% else %>
            <span style="font-size: 0.8em; color: #999; font-style: italic;">No pipelines</span>
          <% end %>
        </div>
        
        <div class="time-series-list">
          <% time_series_list.each do |ts_data| %>
            <% row_class = if ts_data[:has_active_pipelines]
                             ts_data[:up_to_date] ? 'up-to-date' : 'not-up-to-date'
                           else
                             'no-active-pipelines'
                           end %>
            <%= link_to time_series_path(ts_data[:time_series].ticker), 
                class: "time-series-row #{row_class}",
                data: { 
                  ticker: ts_data[:time_series].ticker.downcase,
                  source: ts_data[:time_series].source.downcase,
                  source_id: ts_data[:time_series].source_id&.downcase,
                  description: ts_data[:time_series].description&.downcase
                } do %>
              <div class="row-header">
                <div class="ticker-info">
                  <h3 class="ticker-name"><%= ts_data[:time_series].ticker %></h3>
                  <span class="type-kind"><%= ts_data[:time_series].kind %></span>
                </div>
                <% if ts_data[:last].present? %>
                  <div class="last-value">
                    <%= number_with_precision(ts_data[:last], precision: 2, delimiter: ',') %>
                  </div>
                <% end %>
              </div>

              <% if ts_data[:time_series].description.present? %>
                  <div class="description-text" style="font-size: 0.8em; margin-bottom: 8px;"><%= ts_data[:time_series].description %></div>
                <% end %>
              
              <div class="row-content">
                <div class="row-meta">
                  <div class="meta-group">
                    <span class="meta-label">Timeframe:</span>
                    <span class="meta-value"><%= ts_data[:time_series].timeframe %></span>
                  </div>
                  <div class="meta-group">
                    <span class="meta-label">Data Points:</span>
                    <span class="meta-value"><%= number_with_delimiter(ts_data[:count]) %></span>
                  </div>
                  <div class="meta-group">
                    <span class="meta-label">Since:</span>
                    <span class="meta-value"><%= ts_data[:earliest_ts]&.strftime('%Y-%m-%d') || 'N/A' %></span>
                  </div>
                  <div class="meta-group">
                    <span class="meta-label">Latest:</span>
                    <span class="meta-value"><%= ts_data[:recent_ts]&.strftime('%Y-%m-%d') || 'N/A' %></span>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
function filterTimeSeries(query) {
  const searchTerm = query.toLowerCase().trim();
  const timeSeriesRows = document.querySelectorAll('.time-series-row');
  const sourceGroups = document.querySelectorAll('.source-group');
  
  // If no search term, show all
  if (searchTerm === '') {
    timeSeriesRows.forEach(row => row.style.display = '');
    sourceGroups.forEach(group => group.style.display = '');
    updateSourceCounts();
    return;
  }
  
  // Filter time series rows
  timeSeriesRows.forEach(row => {
    const ticker = row.dataset.ticker || '';
    const source = row.dataset.source || '';
    const sourceId = row.dataset.sourceId || '';
    const description = row.dataset.description || '';
    
    const matches = ticker.includes(searchTerm) || 
                   source.includes(searchTerm) || 
                   sourceId.includes(searchTerm) || 
                   description.includes(searchTerm);
    
    row.style.display = matches ? '' : 'none';
  });
  
  // Hide source groups that have no visible time series
  sourceGroups.forEach(group => {
    const visibleRows = group.querySelectorAll('.time-series-row[style=""], .time-series-row:not([style*="display: none"])');
    group.style.display = visibleRows.length > 0 ? '' : 'none';
  });
  
  updateSourceCounts();
}

function updateSourceCounts() {
  const sourceGroups = document.querySelectorAll('.source-group');
  
  sourceGroups.forEach(group => {
    const visibleRows = group.querySelectorAll('.time-series-row[style=""], .time-series-row:not([style*="display: none"])');
    const countSpan = group.querySelector('h2 span');
    const count = visibleRows.length;
    
    if (countSpan) {
      countSpan.textContent = `(${count} ${count === 1 ? 'series' : 'series'})`;
    }
  });
}
</script>
