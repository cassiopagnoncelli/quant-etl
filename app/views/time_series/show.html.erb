<% content_for :title, "#{@time_series.ticker} - Time Series" %>

<div class="container">
  <div class="header-controls">
    <%= link_to time_series_index_path, class: 'back-link' do %>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5"></path>
        <path d="M12 19l-7-7 7-7"></path>
      </svg>
      Back to Time Series
    <% end %>
    
    <% if @count > 0 %>
      <%= link_to cleanup_time_series_path(@time_series.ticker), 
          method: :delete,
          class: 'cleanup-btn',
          onclick: "return confirm('Are you sure you want to delete all #{number_with_delimiter(@count)} data points for #{@time_series.ticker}? This action cannot be undone.')",
          data: { 
            turbo_method: :delete
          } do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Clean Up Data
      <% end %>
    <% else %>
      <span class="cleanup-btn disabled" title="No data points to clean up">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Clean Up Data
      </span>
    <% end %>
  </div>
  
  <div class="time-series-header">
    <h1 class="time-series-title">
      <%= @time_series.ticker %>
      <span class="type-kind-show"><%= @time_series.kind %></span>
      <% if @last_value.present? %>
        <div class="last-value">
          <%= number_with_precision(@last_value, precision: 2, delimiter: ',') %>
        </div>
      <% end %>
    </h1>
    
    <% if @time_series.description.present? %>
      <div class="description-text" style="font-size: 0.9em; margin-bottom: 1rem; color: #666;"><%= @time_series.description %></div>
    <% end %>
    
    <div class="time-series-meta">
      <div class="meta-group">
        <span class="meta-label">Source:</span>
        <span class="meta-value"><%= @time_series.source %></span>
      </div>
      <div class="meta-group">
        <span class="meta-label">Timeframe:</span>
        <span class="meta-value"><%= @time_series.timeframe %></span>
      </div>
      <div class="meta-group">
        <span class="meta-label">Data Points:</span>
        <span class="meta-value"><%= number_with_delimiter(@count) %></span>
      </div>
      <div class="meta-group">
        <span class="meta-label">Since:</span>
        <span class="meta-value"><%= @earliest_ts&.strftime('%Y-%m-%d') || 'N/A' %></span>
      </div>
      <div class="meta-group">
        <span class="meta-label">Latest:</span>
        <span class="meta-value"><%= @recent_ts&.strftime('%Y-%m-%d') || 'N/A' %></span>
      </div>
      <% if @pipelines.any? %>
        <div class="meta-group">
          <span class="meta-label">Pipelines:</span>
          <div class="meta-value pipelines-inline">
            <% @pipelines.each do |pipeline| %>
              <%= link_to pipeline_path(pipeline), class: "pipeline-link" do %>
                <span class="pipeline-name"><%= pipeline.chain %></span>
                <% if pipeline.latest_run %>
                  <% if pipeline.status == 'COMPLETED' && pipeline.n_failed == 0 && pipeline.n_skipped == 0 %>
                    <span class="pipeline-status success" title="Last run successful">✓</span>
                  <% elsif pipeline.n_failed > 0 %>
                    <span class="pipeline-status failed" title="Last run had failures">✗</span>
                  <% elsif pipeline.n_skipped > 0 %>
                    <span class="pipeline-status skipped" title="Last run had skipped operations">⊘</span>
                  <% else %>
                    <span class="pipeline-status pending" title="<%= pipeline.status.capitalize %>">⏳</span>
                  <% end %>
                <% else %>
                  <span class="pipeline-status pending" title="No runs yet">⏳</span>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="data-section">
    <h2>Recent Data Points</h2>
    
    <% if @data.empty? %>
      <div class="empty-state">
        <h3>No data available</h3>
        <p>This time series doesn't have any data points yet.</p>
      </div>
    <% else %>
      <% if @time_series.kind == 'univariate' %>
        <table class="data-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <% @data.each do |point| %>
              <tr>
                <td><%= point.datetime %></td>
                <td><%= number_with_precision(point.main, precision: 4, delimiter: ',') %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <table class="data-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Open</th>
              <th>High</th>
              <th>Low</th>
              <th>Close</th>
              <th>Adj Close</th>
              <th>Volume</th>
            </tr>
          </thead>
          <tbody>
            <% @data.each do |point| %>
              <tr>
                <td><%= point.datetime %></td>
                <td><%= number_with_precision(point.open, precision: 2, delimiter: ',') if point.open %></td>
                <td><%= number_with_precision(point.high, precision: 2, delimiter: ',') if point.high %></td>
                <td><%= number_with_precision(point.low, precision: 2, delimiter: ',') if point.low %></td>
                <td><%= number_with_precision(point.close, precision: 2, delimiter: ',') if point.close %></td>
                <td><%= number_with_precision(point.adjusted, precision: 2, delimiter: ',') if point.adjusted %></td>
                <td><%= number_with_delimiter(point.volume) if point.volume %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      
      <!-- Pagination Controls -->
      <% if @total_pages > 1 %>
        <div class="pagination-container" style="margin-top: 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
          <div class="pagination-info" style="color: #7f8c8d; font-size: 0.9rem;">
            Showing <%= (@page - 1) * @per_page + 1 %>-<%= [@page * @per_page, @count].min %> of <%= number_with_delimiter(@count) %> records
          </div>
          
          <div class="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center;">
            <!-- First Page -->
            <% if @page > 1 %>
              <%= link_to time_series_path(@time_series.ticker, page: 1), 
                  class: 'pagination-btn', 
                  style: 'padding: 0.5rem 0.75rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem;',
                  title: 'First Page' do %>
                &laquo;&laquo; First
              <% end %>
            <% else %>
              <span class="pagination-btn disabled" 
                    style="padding: 0.5rem 0.75rem; background: #bdc3c7; color: #7f8c8d; border-radius: 4px; font-size: 0.9rem;">
                &laquo;&laquo; First
              </span>
            <% end %>
            
            <!-- Previous Page -->
            <% if @page > 1 %>
              <%= link_to time_series_path(@time_series.ticker, page: @page - 1), 
                  class: 'pagination-btn', 
                  style: 'padding: 0.5rem 0.75rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem;' do %>
                &laquo; Previous
              <% end %>
            <% else %>
              <span class="pagination-btn disabled" 
                    style="padding: 0.5rem 0.75rem; background: #bdc3c7; color: #7f8c8d; border-radius: 4px; font-size: 0.9rem;">
                &laquo; Previous
              </span>
            <% end %>
            
            <!-- Page Numbers -->
            <% start_page = [@page - 2, 1].max %>
            <% end_page = [start_page + 4, @total_pages].min %>
            <% start_page = [end_page - 4, 1].max if end_page - start_page < 4 %>
            
            <% (start_page..end_page).each do |page_num| %>
              <% if page_num == @page %>
                <span class="pagination-btn current" 
                      style="padding: 0.5rem 0.75rem; background: #2c3e50; color: white; border-radius: 4px; font-size: 0.9rem; font-weight: bold;">
                  <%= page_num %>
                </span>
              <% else %>
                <%= link_to page_num, time_series_path(@time_series.ticker, page: page_num), 
                    class: 'pagination-btn', 
                    style: 'padding: 0.5rem 0.75rem; background: #ecf0f1; color: #2c3e50; text-decoration: none; border-radius: 4px; font-size: 0.9rem;' %>
              <% end %>
            <% end %>
            
            <!-- Next Page -->
            <% if @page < @total_pages %>
              <%= link_to time_series_path(@time_series.ticker, page: @page + 1), 
                  class: 'pagination-btn', 
                  style: 'padding: 0.5rem 0.75rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem;' do %>
                Next &raquo;
              <% end %>
            <% else %>
              <span class="pagination-btn disabled" 
                    style="padding: 0.5rem 0.75rem; background: #bdc3c7; color: #7f8c8d; border-radius: 4px; font-size: 0.9rem;">
                Next &raquo;
              </span>
            <% end %>
            
            <!-- Last Page -->
            <% if @page < @total_pages %>
              <%= link_to time_series_path(@time_series.ticker, page: @total_pages), 
                  class: 'pagination-btn', 
                  style: 'padding: 0.5rem 0.75rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9rem;',
                  title: 'Last Page' do %>
                Last &raquo;&raquo;
              <% end %>
            <% else %>
              <span class="pagination-btn disabled" 
                    style="padding: 0.5rem 0.75rem; background: #bdc3c7; color: #7f8c8d; border-radius: 4px; font-size: 0.9rem;">
                Last &raquo;&raquo;
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

</div>

<style>
  .header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #3498db;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }

  .back-link:hover {
    background-color: #f8f9fa;
    text-decoration: none;
    color: #2980b9;
  }

  .cleanup-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: white;
    background-color: #dc3545;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .cleanup-btn:hover {
    background-color: #c82333;
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
  }

  .cleanup-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(220, 53, 69, 0.3);
  }

  .cleanup-btn.disabled {
    background-color: #6c757d;
    color: #adb5bd;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .cleanup-btn.disabled:hover {
    background-color: #6c757d;
    color: #adb5bd;
    transform: none;
    box-shadow: none;
  }

  .pipelines-inline {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .pipeline-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    text-decoration: none;
    color: inherit;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
  }

  .pipeline-link:hover {
    background-color: #f8f9fa;
    text-decoration: none;
    color: inherit;
  }

  .pipeline-name {
    font-weight: 500;
    color: #495057;
  }

  .pipeline-status {
    font-size: 0.9rem;
    margin-left: 0.25rem;
  }

  .pipeline-status.success {
    color: #28a745;
  }

  .pipeline-status.failed {
    color: #dc3545;
  }

  .pipeline-status.pending {
    color: #ffc107;
  }

  .pipeline-status.skipped {
    color: #d97706;
  }
</style>
